<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Eric Zhang]]></title><description><![CDATA[Game Dev - Tool Dev - Math - Machine Learning]]></description><link>https://lxjk.github.io</link><generator>RSS for Node</generator><lastBuildDate>Thu, 03 Nov 2016 06:50:30 GMT</lastBuildDate><atom:link href="https://lxjk.github.io/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title><![CDATA[An Easy Way to Understand Quaternion and Rotation: Part 1. Theory]]></title><description><![CDATA[<div class="sect2">
<h3 id="_before_we_start">Before We Start</h3>
<div class="paragraph">
<p>Quaternion is widely used in game engines to represent 3D rotation. As a game engineer you might be using quaternion explicitly or implicitly in your daily work, but do you really understand what is going on under the hood when you are calling “rotate a vector” or “combine two rotations”? Why rotating a vector \(\vec{v}\) by quaternion \(q\) is calculated by a “sandwich” multiplication: \(q\vec{v}q^{-1}\) ? Why rotating by quaternion \(q_1\) then \(q_2\) is in the reversed order: \({q_2}{q_1}\), and can you visualize the result rotation axis and angle?</p>
</div>
<div class="paragraph">
<p>Understanding quaternions also leads to more efficient use of quaternion. For example, one common situation in game development is that we need an object to face its opposite direction. What we usually would do is to get the normal or forward vector, negate it, build a rotation out of it, and assign the rotation to the object. Later in this article we will see how much calculation we need to do in this process. However with the understanding of quaternion, we only need to do \(q=(q.y,-q.x,q.w,-q.z)\), and I will show you why.</p>
</div>
<div class="paragraph">
<p>In this article, I will try to avoid touching the algebra structure of quaternion, or having to imagine a 4 dimensional hyper sphere. I will start with a special rotation operation: flip, and use that to visualize quaternion in a more accessible and geometrical way. This article will be split into 2 parts. In Part 1 we will talk about the idea of quaternion, understand and visualize how it rotates a vector and how to compose rotations. In Part 2 we will talk about how to make use of our understanding in Part 1, and how it is used in game engine versus rotation matrix and Euler angle.</p>
</div>
<div class="paragraph">
<p>I would assume you are comfortable with 3D math (vector dot product and cross product) and basic trigonometry.</p>
</div>
</div>
<div class="sect2">
<h3 id="_quaternion_definition">Quaternion Definition</h3>
<div class="paragraph">
<p>Quaternion is a 4-tuple denoted as \(q=(x,y,z,w)\). The length of a quaternion is defined as \(\left|q\right| =\sqrt{x^{2}+y^{2}+z^{2}+w^{2}}\), just as you would expected from a 4D vector.</p>
</div>
<div class="paragraph">
<p>In order to represent 3D rotation, we have a constraint on the quaternions we use. But before that I want to introduce Euler’s rotation theorem:</p>
</div>
<div class="paragraph">
<p><strong><em>Any rotation in 3D space is equivalent to a single rotation of angle \(θ\) along some axis \(\vec{v}\).</em></strong></p>
</div>
<div class="paragraph">
<p>We can use quaternion to describe this angle-axis rotation : \(q=(sin⁡\frac{θ}{2}\vec{v}.x,sin⁡\frac{θ}{2}\vec{v}.y,sin⁡\frac{θ}{2}\vec{v}.z,cos⁡\frac{θ}{2})\), or in a more compact form \(q=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\). We call this form the vector form of a quaternion, and we will use this form throughout this article. You might be thinking why we are using \(\frac{θ}{2}\) other than using \(θ\) directly. I will explain that in a later section.</p>
</div>
<div class="paragraph">
<p>It is easy to see the length of this quaternion \(\left|q\right|=\sqrt{sin^{2}\frac{θ}{2}\left|\vec{v}\right|^{2}+cos^{2}\frac{θ}{2}}=1\). (Remember the axis \(\vec{v}\) is a unit vector that \(\left|\vec{v}\right|=1\)). We call it a unit quaternion if the length \(\left|q\right|=1\). So we can rewrite Euler’s rotation theorem in quaternion term:</p>
</div>
<div class="paragraph">
<p><strong><em>Any 3D rotation is equivalent a unit quaternion \(q\) that \(\left|q\right|=1\).</em></strong></p>
</div>
<hr>
<div class="sidebarblock">
<div class="content">
<div class="title">Side Note</div>
<div class="paragraph">
<p>This claim actually has 2 sides. Let me go a little be more in details in math term:
(1). For any 3D rotation equivalent to a rotation angle \(θ\) along axis \(\vec{v}\), there exists a unit quaternion \(q=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\) to describe this rotation.
(2). For any unit quaternion \(q=(x,y,z,w)\), it describes a rotation of angle \(θ=2cos^{-1}w\) along axis \(\vec{v}=\frac{(x,y,z)}{\sqrt{1-w^{2}}}\).</p>
</div>
</div>
</div>
<hr>
<div class="paragraph">
<p>From now on, any quaternion \(q\) used in this article is by default a unit quaternion, and we will use \(q\) to describe rotations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rotation_and_flip">Rotation and Flip</h3>
<div class="paragraph">
<p>Now let’s forget quaternion for a minute, and focus on the nature of rotations. This part is the key to understand quaternion calculation in an easier way.</p>
</div>
<div class="paragraph">
<p><strong><em>Any 3D rotation can be composed by 2 flips along some axes.</em></strong></p>
</div>
<div class="paragraph">
<p>The reason we want to break down a rotation into flips, is that flips are much easier to think and calculate than general 3D rotation. We will start from flip and build our way to understand rotation.
Here is a loose proof of this idea. We define counter-clockwise as the positive direction of rotation. First consider a special case. We have a rotation \(q\), which rotates  \(+90^{\circ}\) along axis \(\vec{Z}\). Now I can say this rotation is the same as 2 flips along axis \(\vec{a}\) and \(\vec{b}\), both of them are on XY plane, and the angle from \(\vec{a}\) to \(\vec{b}\) is \(+45^{\circ}\).</p>
</div>
<div class="imageblock" style="text-align: center;float: right">
<div class="content">
<img src="https://github.com/lxjk/lxjk.github.io/raw/master/images/quaternions/fig1.png" alt="fig1.png" width="300">
</div>
<div class="title">Figure 1 (a)</div>
</div>
<div class="imageblock" style="text-align: center;float: right">
<div class="content">
<img src="https://github.com/lxjk/lxjk.github.io/raw/master/images/quaternions/fig1_b.png" alt="fig1 b.png" width="300">
</div>
<div class="title">Figure 1 (b)</div>
</div>
<div class="paragraph">
<p>We demonstrate this through Figure 1. For any vector \(\vec{v}\), the result of this rotation is \(\vec{v''}\) , which is the same as flip \(\vec{v}\) along axis \(\vec{a}\) and get \(\vec{v'}\), and then flip \(\vec{v'}\) along axis \(\vec{b}\) and get \(\vec{v''}\).</p>
</div>
<div class="paragraph">
<p>It doesn’t matter where \(\vec{a}\) and \(\vec{b}\) are on the XY plane, but the order must be kept. If we choose \(\vec{b}\) by rotating \(\vec{a}\) along axis \(\vec{Z}\) by \(+45^{\circ}\) with the positive direction we defined above, then we must flip along \(\vec{a}\) first then along \(\vec{b}\) to get our target rotation. The order and the sign of angle is important, as you can easily see flip along \(\vec{b}\) first then along \(\vec{a}\) will give a different result.</p>
</div>
<div class="paragraph">
<p>It’s not hard to generalize to a rotation of any angle \(θ\) along \(\vec{Z}\) axis. And in this case, the angle from \(\vec{a}\) to \(\vec{b}\) is \(\frac{θ}{2}\).</p>
</div>
<div class="paragraph">
<p>What if the axis is not \(\vec{Z}\) axis but any unit vector \(\vec{u}\) ? It turns out to be very straight forward. \(\vec{a}\) and \(\vec{b}\) are no longer on XY plane but on a plane cross the origin and perpendicular to \(\vec{u}\), as in Figure 2.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="https://github.com/lxjk/lxjk.github.io/raw/master/images/quaternions/fig2.png" alt="fig2.png" width="400">
</div>
<div class="title">Figure 2</div>
</div>
<div class="paragraph">
<p>Now we can rewrite our flip composition rule in a more specific form:</p>
</div>
<div class="paragraph">
<p><strong><em>Any 3D rotation equivalent to rotating angle \(θ\) along axis \(\vec{v}\) can be represented as a sequence of 2 flips along axis \(\vec{a}\) and \(\vec{b}\), such that \(\vec{a}·\vec{v}=0\), \(\vec{b}·\vec{v}=0\) and the angle from \(\vec{a}\) to \(\vec{b}\): \(&lt;\vec{a},\vec{b}&gt;=\frac{θ}{2}\).</em></strong></p>
</div>
<div class="paragraph">
<p>This representation means if we fully understand flip, which is easier to visualize, we can fully understand rotation and quaternions, since any quaternion can be broken down to flips.</p>
</div>
</div>
<div class="sect2">
<h3 id="_quaternion_and_flip">Quaternion and Flip</h3>
<div class="paragraph">
<p>Now let’s recall the quaternion vector form \(q=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\). With the discussion of flips above, you can almost immediately see why we are using \(\frac{θ}{2}\) here.</p>
</div>
<div class="paragraph">
<p>Think about flips again. A flip along axis \(\vec{a}\) is also a \(180^{\circ}\) rotation along axis \(\vec{a}\). So this flip can be represented in quaternion term</p>
</div>
<div class="stemblock">
<div class="content">
\[q_a=(sin⁡\frac{180^{\circ}}{2}\vec{a},cos⁡\frac{180^{\circ}}{2})=(\vec{a},0)\]
</div>
</div>
<div class="paragraph">
<p>From now on we will use quaternion to represent flip. Actually any unit quaternion with \(q.w=0\) is a flip along axis \((q.x,q.y,q.z)\).</p>
</div>
</div>
<div class="sect2">
<h3 id="_flip_composition">Flip Composition</h3>
<div class="paragraph">
<p>Here we need to introduce the multiplication of general quaternion. Let \(q_1=(\vec{v_1},w_1)\), \(q_2=(\vec{v_2},w_2)\) then</p>
</div>
<div class="stemblock">
<div class="content">
\[{q_1}{q_2}=(\vec{v_1},w_1)(\vec{v_2},w_2)=(w_1\vec{v_2} + w_2\vec{v_1} + \vec{v_1}×\vec{v_2}, {w_1}{w_2}-\vec{v_1}·\vec{v_2})\]
</div>
</div>
<div class="paragraph">
<p>Note here \(q_1\) and \(q_2\) are not necessarily unit quaternion, so even I’m using vector form, there’s no need to put \(sin⁡\frac{θ}{2}\) and \(cos⁡\frac{θ}{2}\) as we did for unit quaternions. It’s hard to explain this definition without introducing the algebra structure of quaternions, so I will skip that. If you are interesting to know how this is derived, quaternion <a href="https://en.wikipedia.org/wiki/Quaternion#Definition">Wiki page</a> has a very straight forward introduction.</p>
</div>
<div class="paragraph">
<p>We are not going to use this general quaternion multiplication in Part 1. Here we only need to know a simpler form, the multiplication of flips. Let \(q_a=(\vec{a},0)\), \(q_b=(\vec{b},0)\) then</p>
</div>
<div class="stemblock">
<div class="content">
\[{q_a}{q_b}=(\vec{a},0)(\vec{b},0)=(\vec{a}×\vec{b},-\vec{a}·\vec{b})\]
</div>
</div>
<div class="paragraph">
<p>It is naturally derived from the general form, and we will be only using this multiplication in Part 1.</p>
</div>
<div class="paragraph">
<p>With flip multiplication defined, we can rewrite our flip composition rule again:</p>
</div>
<div class="paragraph">
<p><strong><em>Any 3D rotation \(q=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\) can be represented as a sequence of 2 flips \(q_a=(\vec{a},0)\) and \(q_b=(\vec{b},0)\), such that</em></strong></p>
</div>
<div class="stemblock">
<div class="content">
\[q=-{q_b}{q_a}\]
</div>
</div>
<div class="paragraph">
<p><strong><em>where \(\vec{a}·\vec{v}=0\), \(\vec{b}·\vec{v}=0\) and the angle from \(\vec{a}\) to \(\vec{b}\): \(&lt;\vec{a},\vec{b}&gt;=\frac{θ}{2}\).</em></strong></p>
</div>
<div class="paragraph">
<p>You might be thinking why it is not \(q= {q_a}{q_b}\) instead. We will show where the order and the negative sign coming from in the proof.</p>
</div>
<div class="paragraph">
<p>\(\vec{a}·\vec{b}=cos&lt;\vec{a},\vec{b}&gt;\left|\vec{a}\right|\left|\vec{b}\right|=cos\frac{θ}{2}\). Since \(\vec{a}·\vec{v}=0\), \(\vec{b}·\vec{v}=0\) and \(\left|\vec{v}\right|=1\), we have \(\vec{a}×\vec{b}=sin&lt;\vec{a},\vec{b}&gt;\left|\vec{a}\right|\left|\vec{b}\right|\vec{v}=sin\frac{θ}{2}\vec{v}\).</p>
</div>
<div class="paragraph">
<p>If you are not sure about the direction of the cross product, see Figure 2.</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
q&amp;=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\\
&amp;=(\vec{a}×\vec{b},\vec{a}·\vec{b})\\
&amp;=-(-\vec{a}×\vec{b},-\vec{a}·\vec{b})\\
&amp;=(\vec{b}×\vec{a},-\vec{a}·\vec{b})\\
&amp;=-{q_b}{q_a}
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>Here you can also clearly see why we are using \(sin⁡\frac{θ}{2}\) and \(cos⁡\frac{θ}{2}\) in quaternions.</p>
</div>
<div class="paragraph">
<p>One thing I need to mention here is the negation of a quaternion. \(q=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\), then</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
{-q}&amp;=(-sin⁡\frac{θ}{2}\vec{v},-cos⁡\frac{θ}{2})\\
&amp;=(-sin⁡\frac{2π-θ}{2}\vec{v},cos⁡\frac{2π-θ}{2})\\
&amp;=(sin⁡\frac{-(2π-θ)}{2}\vec{v},cos⁡\frac{-(2π-θ)}{2})\\
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>Recall that \(sin⁡θ=sin(π-θ)\) and \(-cos⁡θ=cos(π-θ)\), then \(-sin⁡θ=sin(-θ)\) and \(cos⁡θ=cos(-θ)\).</p>
</div>
<div class="paragraph">
<p>It shows that \(-q\) is a rotation along axis \(\vec{v}\) of angle \(-(2π-θ)\), which is exactly the same rotation as \(q\). For example if \(θ=90^{\circ}\) then \(-(2π-θ)=-270^{\circ}\), rotate \(90^{\circ}\) along axis \(\vec{v}\) is the same as rotate \(270^{\circ}\) degree but in the opposite direction along the same axis \(\vec{v}\).</p>
</div>
<div class="paragraph">
<p>The fact that \(q\) and \(–q\) represents the same rotation is usually called double-cover. However in our calculation I don’t want you to simply think \(q\) and \(–q\) are the same. They are different in quaternion space, even though they map to the same 3D rotation. The negative sign of the flip composition needs to be there.</p>
</div>
<div class="paragraph">
<p>The order of \(q=-{q_b}{q_a}\) on the right hand side is important. It means flip along \(\vec{a}\) first and then \(\vec{b}\). Actually all unit quaternion multiplication needs to be “read” from right to left when we are thinking about the order of applying those rotations.</p>
</div>
<hr>
<div class="sidebarblock">
<div class="content">
<div class="title">Side Note</div>
<div class="paragraph">
<p>We can however get rid of the negative sign by choosing \(\vec{a}\) and \(\vec{b}\) differently.</p>
</div>
<div class="paragraph">
<p><em>Any 3D rotation \(q=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\) can be represented as a sequence of 2 flips \(q_a=(\vec{a},0)\) and \(q_b=(\vec{b},0)\), such that
\(q={q_b}{q_a}\)
where \(\vec{a}·\vec{v}=0\), \(\vec{b}·\vec{v}=0\) and the angle from \(\vec{a}\) to \(\vec{b}\): \(&lt;\vec{a},\vec{b}&gt;=\frac{θ}{2}-π\).</em></p>
</div>
<div class="paragraph">
<p>It becomes harder to visualize \(\vec{a}\) and \(\vec{b}\) if we go this way, and the negative sign does not really introduce a lot of difficulties, so we will stick with that negative sign in this article.</p>
</div>
</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_flip_vector">Flip Vector</h3>
<div class="paragraph">
<p>Given a flip \(q_a=(\vec{a},0)\) and vector \(\vec{v}\), we are ready to calculate the result of the flip \(\vec{v'}\).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="https://github.com/lxjk/lxjk.github.io/raw/master/images/quaternions/fig3.png" alt="fig3.png" width="400">
</div>
<div class="title">Figure 3</div>
</div>
<div class="paragraph">
<p>According to flip definition, \(\vec{v}\), \(\vec{a}\) and \(\vec{v'}\) are on the same plane, and the angle \(&lt;\vec{v},\vec{a}&gt;=&lt;\vec{a},\vec{v'}&gt;\).</p>
</div>
<div class="paragraph">
<p>If we treat \(\vec{v}\) and \(\vec{v'}\) as the axis of flip \(q_v=(\vec{v},0)\) and \(q_v'=(\vec{v'},0)\). From our flip composition rule, flipping along axis \(\vec{v}\) then \(\vec{a}\) should give us the same rotation as flipping along axis \(\vec{a}\) then \(\vec{v'}\).</p>
</div>
<div class="paragraph">
<p>We can actually calculate the result rotation. Let \(&lt;\vec{v},\vec{a}&gt;=&lt;\vec{a},\vec{v'}&gt;=\frac{θ}{2}\), \(\vec{u}=\frac{\vec{v}×\vec{a}}{\left|\vec{v}×\vec{a}\right|}=\frac{\vec{a}×\vec{v'}}{\left|\vec{a}×\vec{v'}\right|}\). Then the result rotation is of angle \(θ\) along axis \(\vec{u}\).</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
q&amp;=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\\
&amp;=-{q_a}{q_v}\\
&amp;=-{q_v'}{q_a}
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>This gives \({q_v'}{q_a}={q_a}{q_v}\).</p>
</div>
<div class="paragraph">
<p>(Here \(\left|\vec{v}×\vec{a}\right|=\left|\vec{a}×\vec{v'}\right|=sin\frac{θ}{2}\).If you are not sure what’s going on here, go back “Flip Composition” and read the proof)</p>
</div>
<div class="paragraph">
<p>Now we need to introduce the inverse of a quaternion. The inverse of \(q\) is denoted as \(q^{-1}\), such that \(qq^{-1}=q^{-1}q=(\vec{0},1)\).</p>
</div>
<div class="paragraph">
<p>\(I=(\vec{0},1)\) is called identity quaternion, means no rotation at all. You can think of \(I=(sin⁡0\vec{v},cos⁡0)\), which means rotating \(0^{\circ}\) along any axis \(\vec{v}\). We haven’t gone into quaternion multiplication or rotation composition, but it’s not hard to see for any quaternion \(q\), \(qI=Iq=q\).</p>
</div>
<div class="paragraph">
<p>In the case of unit quaternion, the idea of inversed quaternion is if you apply a rotation, then apply its inverse, the result should be no rotation at all. And it is the same if you apply an inversed rotation then apply the original one.</p>
</div>
<div class="paragraph">
<p>For any unit quaternion \(q=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\), then \(q^{-1}=(-sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\). You can understand this in two ways, either \(q^{-1}=(sin⁡\frac{θ}{2}(-\vec{v}),cos⁡\frac{θ}{2})\) or \(q^{-1}=(sin⁡\frac{-θ}{2}\vec{v},cos⁡\frac{-θ}{2})\). \(q^{-1}\) is either a rotation of angle \(θ\) along axis \(-\vec{v}\), or a rotation of angle \(–θ\) along axis \(\vec{v}\). Either way it will cancel out the original rotation.</p>
</div>
<div class="paragraph">
<p>I will give a quick proof in the case of flip. You can try extend this proof to general unit quaternion. If \(q_a=(\vec{a},0)\), \(q_a^{-1}=(-\vec{a},0)\), we have</p>
</div>
<div class="stemblock">
<div class="content">
\[{q_a}{q_a^{-1}}=(\vec{a}×-\vec{a},-(\vec{a}·-\vec{a}))=(\vec{0},1)\]
</div>
</div>
<div class="paragraph">
<p>(Make sure you understand the difference between \(q^{-1}\) and \(–q\). Read “Flip Composition” about quaternion negation if you are not sure.)</p>
</div>
<div class="paragraph">
<p>We can go back to previous result of flipping vector \({q_v'}{q_a}={q_a}{q_v}\). Apply inverse flip of q_a on both side, the equation becomes</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
{q_v'}{q_a}{q_a^{-1}}&amp;={q_a}{q_v}{q_a^{-1}}\\
q_v'&amp;={q_a}{q_v}{q_a^{-1}}
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>This provides us a way to calculate the result of flip. Since we only need the vector part of the result, we can denote this as</p>
</div>
<div class="stemblock">
<div class="content">
\[\vec{v'}={q_a}\vec{v}{q_a^{-1}}\]
</div>
</div>
<div class="paragraph">
<p>When we put a vector \(\vec{v}\) in quaternion multiplication, we are implicitly making that vector the axis of a flip to stuff it into a quaternion \((\vec{v},0)\). This is how the “sandwich” multiplication form comes from, but only in the form of flip. We will prove that our result holds the same for any rotation in the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rotate_vector">Rotate Vector</h3>
<div class="paragraph">
<p>We know any 3D rotation \(q\) can be broken down into 2 flips \(q= -{q_b}{q_a}\), which means flipping along \(\vec{a}\) first and then \(\vec{b}\). So for a vector \(\vec{v}\), we apply the first flip and get</p>
</div>
<div class="stemblock">
<div class="content">
\[\vec{v'}={q_a}\vec{v}{q_a^{-1}}\]
</div>
</div>
<div class="paragraph">
<p>Then we apply the second flip \(\vec{v'}\) and get</p>
</div>
<div class="stemblock">
<div class="content">
\[\vec{v''}={q_b}\vec{v'}{q_b^{-1}}\]
</div>
</div>
<div class="paragraph">
<p>So the final result is</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
\vec{v''}&amp;={q_b}{q_a}\vec{v}{q_a^{-1}}{q_b^{-1}}\\
&amp;=({q_b}{q_a})\vec{v}({q_b}{q_a})^{-1}\\
&amp;=(-q)\vec{v}(-q^{-1})\\
&amp;=q\vec{v}q^{-1}\\
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>Here you can see why \(q= -{q_b}{q_a}\) needs to be in this order.</p>
</div>
<div class="paragraph">
<p>One thing we need to prove</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
{q_a^{-1}}{q_b^{-1}}&amp;=(-\vec{a},0)(-\vec{b},0)\\
&amp;=(-\vec{a}×-\vec{b},-(-\vec{a})·(-\vec{b}))\\
&amp;=(\vec{a}×\vec{b},-\vec{a}·\vec{b})\\
&amp;=(-\vec{b}×\vec{a},-\vec{b}·\vec{a})\\
&amp;=({q_b}{q_a})^{-1}
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>At this point, we fully explained how to rotate a vector using quaternion.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rotation_composition">Rotation Composition</h3>
<div class="paragraph">
<p>Given rotation \(q_1\) and \(q_2\), from the formula in the previous section, if we rotate vector \(\vec{v}\) by \(q_1\) first then by \(q_2\), we have</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
\vec{v'}&amp;={q_1}\vec{v}{q_1^{-1}}\\
\vec{v''}&amp;={q_2}\vec{v'}{q_2^{-1}}\\
&amp;={q_2}{q_1}\vec{v}{q_1^{-1}}{q_2^{-1}}\\
&amp;=({q_2}{q_1})\vec{v}({q_2}{q_1})^{-1}\\
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>It is the same as apply the combined rotation \(q={q_2}{q_1}\). Be careful about the multiplication order.</p>
</div>
<div class="paragraph">
<p>Again we need to prove \({q_1^{-1}}{q_2^{-1}}=({q_2}{q_1})^{-1}\), but we will do this later. This equation is actually very easy to understand in geometric term. We have a combined rotation \(q={q_2}{q_1}\) that rotates \(q_1\) first then rotates \(q_2\). If we want to undo this rotation, which means apply the inverse \(q^{-1}=({q_2}{q_1})^{-1}\), we need to undo \(q_2\) first then undo \(q_1\), that is effectively \(q_1^{-1}q_2^{-1}\).</p>
</div>
<div class="paragraph">
<p>What does it really mean to combine 2 rotations, can we visualize the rotation axis and angle of the result? By converting rotations to flips we actually do that.</p>
</div>
<div class="paragraph">
<p>Let \(q_1=(sin⁡\frac{θ_1}{2}\vec{v_1},cos⁡\frac{θ_1}{2})\), \(q_2=(sin⁡\frac{θ_2}{2}\vec{v_2},cos⁡\frac{θ_2}{2})\), we need to choose a special flip break down, such that they share one flip: \(q_1=-{q_c}{q_a}\), \(q_2=-{q_b}{q_c}\).</p>
</div>
<div class="paragraph">
<p>Can we find such a break down? Remember the rule of flip composition requires the flip axis to be perpendicular to the rotation axis, that is \(\vec{c}·\vec{v_1}=0\), \(\vec{c}·\vec{v_2}=0\), we can choose \(\vec{c}=\frac{\vec{v_1}×\vec{v_2}}{\left|\vec{v_1}×\vec{v_2}\right|}\).</p>
</div>
<div class="paragraph">
<p>Based on \(\vec{c}\) we can find out the other two axes: rotate \(\vec{c}\) along axis \(\vec{v_1}\) by angle \(-\frac{θ_1}{2}\) results in \(\vec{a}\); rotate \(\vec{c}\) along axis \(\vec{v_2}\) by angle \(\frac{θ_2}{2}\) results in \(\vec{b}\). This process is demonstrated in Figure 4.</p>
</div>
<div class="paragraph">
<p>Now we have \(\vec{a}·\vec{v_1}=0\), \(\vec{c}·\vec{v_1}=0\), \(&lt;\vec{a},\vec{c}&gt;=\frac{θ_1}{2}\) and \(\vec{c}·\vec{v_2}=0\), \(\vec{b}·\vec{v_2}=0\), \(&lt;\vec{c},\vec{b}&gt;=\frac{θ_2}{2}\). Our break down \(q_1=-{q_c}{q_a}\), \(q_2=-{q_b}{q_c}\) is valid. The combined rotation can be written as</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
q&amp;={q_2}{q_1}\\
&amp;=(-{q_b}{q_c})(-{q_c}{q_a})\\
&amp;={q_b}({q_c}{q_c}){q_a}\\
&amp;=-{q_b}{q_a}\\
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>Here we need to prove this</p>
</div>
<div class="stemblock">
<div class="content">
\[{q_c}{q_c}=(\vec{c},0)(\vec{c},0)=(\vec{c}×\vec{c},-(\vec{c}·\vec{c}))=(\vec{0},-1)=-I\]
</div>
</div>
<div class="paragraph">
<p>It shows that the combined rotation can be composed by flip \(q_a\) and \(q_b\), which tells the combined rotation is a rotation of angle \(2&lt;\vec{a},\vec{b}&gt;\) along axis \(\vec{u}=\frac{\vec{a}×\vec{b}}{\left|\vec{a}×\vec{b}\right|}\).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="https://github.com/lxjk/lxjk.github.io/raw/master/images/quaternions/fig4.png" alt="fig4.png" width="400">
</div>
<div class="title">Figure 4</div>
</div>
<div class="paragraph">
<p>In Figure 4, Blue plane is based on \(\vec{v_1}\) and \(\vec{v_1}\), \(\vec{c}\) is perpendicular to that plane.
Orange plane is based on \(\vec{a}\) and \(\vec{b}\), the result rotation axis \(\vec{u}\) is perpendicular to that plane.</p>
</div>
<div class="paragraph">
<p>With the same method, let’s prove the thing we left out:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
{q_1^{-1}}{q_2^{-1}}&amp;=(-{q_c}{q_a})^{-1}(-{q_b}{q_c})^{-1}\\
&amp;={q_a^{-1}}{q_c^{-1}}{q_c^{-1}}{q_b^{-1}}\\
&amp;=-{q_a^{-1}}{q_b^{-1}}\\
&amp;=(-{q_b}{q_a})^{-1}\\
&amp;=({q_b}{q_c}{q_c}{q_a})^{-1}\\
&amp;=({q_2}{q_1})^{-1}\\
\end{align*}\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_of_part_1">Summary of Part 1</h3>
<div class="paragraph">
<p>In Part 1, we covered the definition of quaternion \(q=(x,y,z,w)\), the vector form of quaternion \(q=(\vec{v},w)\), unit quaternion \(q=(sin⁡\frac{θ}{2}\vec{v},cos⁡\frac{θ}{2})\) and how it is used to represent a rotation.</p>
</div>
<div class="paragraph">
<p>We also talked about negation of quaternion \(–q\), and its double cover property; the inverse of quaternion \(q^{-1}\) and identity quaternion \(I=(\vec{0},1)\).</p>
</div>
<div class="paragraph">
<p>We use quaternion to represent flip \(q_a=(\vec{a},0)\), and derive the rule of flip composition \(q=-{q_b}{q_a}\). Based on this rule, we visualized and proved how quaternion rotates a vector by \(\vec{v'}=q\vec{v}q^{-1}\) and how rotation gets composed by \(q={q_2}{q_1}\).</p>
</div>
<div class="paragraph">
<p>We slightly touched quaternion multiplication, and we proved an important equation \({q_1^{-1}}{q_2^{-1}}=({q_2}{q_1})^{-1}\).</p>
</div>
</div>
<div class="sect2">
<h3 id="_appendix_derive_quaternion_multiplication">Appendix: Derive Quaternion Multiplication</h3>
<div class="paragraph">
<p>This part is not very important for understanding quaternion. It is a bit calculation heavy and is more for fun. Feel free to skip.</p>
</div>
<div class="paragraph">
<p>We can actually derive the general quaternion multiplication from this special flip break down. That is if we define flip multiplication \({q_a}{q_b}=(\vec{a},0)(\vec{b},0)=(\vec{a}×\vec{b},-\vec{a}·\vec{b})\) directly, we can proof what general quaternion multiplication \({q_1}{q_2}=(sin⁡\frac{θ_1}{2}\vec{v_1},cos⁡\frac{θ_1}{2})(sin⁡\frac{θ_2}{2}\vec{v_2},cos⁡\frac{θ_2}{2})\) would look like.</p>
</div>
<div class="paragraph">
<p>Here are some equations we will be using:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
\vec{a}×(\vec{b}×\vec{c})&amp;=(\vec{a}·\vec{c})\vec{b}-(\vec{a}·\vec{b})\vec{c}\\
(\vec{a}×\vec{b})·(\vec{c}×\vec{d})&amp;=(\vec{a}·\vec{c})(\vec{b}·\vec{d})-(\vec{a}·\vec{d})(\vec{b}·\vec{c})\\
(\vec{a}×\vec{b})×(\vec{a}×\vec{c})&amp;=(\vec{a}·(\vec{b}×\vec{c}))\vec{a}
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>Recall how we choose the flip break down \(\vec{c}=\frac{\vec{v_1}×\vec{v_2}}{\left|\vec{v_1}×\vec{v_2}\right|}\).</p>
</div>
<div class="paragraph">
<p>Rotate \(\vec{c}\) along axis \(\vec{v_1}\) by angle \(-\frac{θ_1}{2}\) we get</p>
</div>
<div class="stemblock">
<div class="content">
\[\vec{a}=cos\frac{-θ_1}{2}\vec{c} + sin\frac{-θ_1}{2}(\vec{v_1}×\vec{c})=\frac{1}{\left|\vec{v_1}×\vec{v_2}\right|}(cos\frac{θ_1}{2}(\vec{v_1}×\vec{v_2}) - sin\frac{θ_1}{2}(\vec{v_1}×(\vec{v_1}×\vec{v_2})))\]
</div>
</div>
<div class="paragraph">
<p>Rotate \(\vec{c}\) along axis \(\vec{v_2}\) by angle \(\frac{θ_2}{2}\) we get</p>
</div>
<div class="stemblock">
<div class="content">
\[\vec{b}=cos\frac{θ_2}{2}\vec{c} + sin\frac{θ_2}{2}(\vec{v_2}×\vec{c})=\frac{1}{\left|\vec{v_1}×\vec{v_2}\right|}(cos\frac{θ_2}{2}(\vec{v_1}×\vec{v_2}) + sin\frac{θ_2}{2}(\vec{v_2}×(\vec{v_1}×\vec{v_2})))\]
</div>
</div>
<div class="paragraph">
<p>And we will have</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
\vec{a}·\vec{b}&amp;=\frac{1}{{\left|\vec{v_1}×\vec{v_2}\right|}^{2}}(cos\frac{θ_1}{2}cos\frac{θ_2}{2}{\left|\vec{v_1}×\vec{v_2}\right|}^{2} - sin\frac{θ_1}{2}sin\frac{θ_2}{2}((\vec{v_1}×(\vec{v_1}×\vec{v_2}))·(\vec{v_2}×(\vec{v_1}×\vec{v_2}))))\\
&amp;=\frac{1}{{\left|\vec{v_1}×\vec{v_2}\right|}^{2}}(cos\frac{θ_1}{2}cos\frac{θ_2}{2}{\left|\vec{v_1}×\vec{v_2}\right|}^{2} - sin\frac{θ_1}{2}sin\frac{θ_2}{2}(\vec{v_1}·\vec{v_2}){\left|\vec{v_1}×\vec{v_2}\right|}^{2})\\
&amp;=cos\frac{θ_1}{2}cos\frac{θ_2}{2} - sin\frac{θ_1}{2}sin\frac{θ_2}{2}(\vec{v_1}·\vec{v_2})
\end{align*}\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
\vec{a}×\vec{b}&amp;=\frac{1}{{\left|\vec{v_1}×\vec{v_2}\right|}^{2}}(cos\frac{θ_1}{2}sin\frac{θ_2}{2}((\vec{v_1}×\vec{v_2})×(\vec{v_2}×(\vec{v_1}×\vec{v_2})))\\
&amp;- sin\frac{θ_1}{2}cos\frac{θ_2}{2}((\vec{v_1}×(\vec{v_1}×\vec{v_2}))×(\vec{v_1}×\vec{v_2})\\
&amp;- sin\frac{θ_1}{2}sin\frac{θ_2}{2}((\vec{v_1}×(\vec{v_1}×\vec{v_2}))×(\vec{v_2}×(\vec{v_1}×\vec{v_2}))))\\
&amp;=\frac{1}{{\left|\vec{v_1}×\vec{v_2}\right|}^{2}}(cos\frac{θ_1}{2}sin\frac{θ_2}{2}{\left|\vec{v_1}×\vec{v_2}\right|}^{2}\vec{v_2} + sin\frac{θ_1}{2}cos\frac{θ_2}{2}{\left|\vec{v_1}×\vec{v_2}\right|}^{2}\vec{v_1} - sin\frac{θ_1}{2}sin\frac{θ_2}{2}{\left|\vec{v_1}×\vec{v_2}\right|}^{2}(\vec{v_1}×\vec{v_2}))\\
&amp;=cos\frac{θ_1}{2}sin\frac{θ_2}{2}\vec{v_2} + sin\frac{θ_1}{2}cos\frac{θ_2}{2}\vec{v_1} - sin\frac{θ_1}{2}sin\frac{θ_2}{2}(\vec{v_1}×\vec{v_2})
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>From the previous proof of rotation composition we know \(q={q_2}{q_1}=-{q_b}{q_a}\), that is</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
q&amp;=(\vec{a}×\vec{b},\vec{a}·\vec{b})\\
&amp;=(cos\frac{θ_1}{2}(sin\frac{θ_2}{2}\vec{v_2}) + cos\frac{θ_2}{2}(sin\frac{θ_1}{2}\vec{v_1}) - (sin\frac{θ_1}{2}\vec{v_1})×(sin\frac{θ_2}{2}\vec{v_2}), cos\frac{θ_1}{2}cos\frac{θ_2}{2} - (sin\frac{θ_1}{2}\vec{v_1})·(sin\frac{θ_2}{2}\vec{v_2}))
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>which is the definition of quaternion multiplication of \({q_1}{q_2}=(sin⁡\frac{θ_1}{2}\vec{v_1},cos⁡\frac{θ_1}{2})(sin⁡\frac{θ_2}{2}\vec{v_2},cos⁡\frac{θ_2}{2})\).</p>
</div>
</div>]]></description><link>https://lxjk.github.io/2016/10/29/An-Easy-Way-to-Understand-Quaternion-and-Rotation-Part-1-Theory.html</link><guid isPermaLink="true">https://lxjk.github.io/2016/10/29/An-Easy-Way-to-Understand-Quaternion-and-Rotation-Part-1-Theory.html</guid><dc:creator><![CDATA[Eric Zhang]]></dc:creator><pubDate>Sat, 29 Oct 2016 00:00:00 GMT</pubDate></item></channel></rss>